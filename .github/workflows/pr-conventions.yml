name: Check PR Conventions

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

permissions:
  pull-requests: write

jobs:
  check-conventions:
    name: Check PR Conventions
    runs-on: ubuntu-latest

    steps:
      - name: Check PR title follows Conventional Commits
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title;

            // Conventional Commits pattern
            const pattern = /^(feat|fix|docs|style|refactor|perf|test|chore|revert)(\(.+?\))?: .+/;

            if (!pattern.test(title)) {
              const comment = [
                'âŒ **PR Title Check Failed**',
                '',
                "Your PR title doesn't follow [Conventional Commits](https://www.conventionalcommits.org/) format.",
                '',
                `**Current title:** \`${title}\``,
                '',
                '**Expected format:** \`type(scope): description\`',
                '',
                '**Valid types:**',
                '- \`feat\`: New feature',
                '- \`fix\`: Bug fix',
                '- \`docs\`: Documentation only',
                '- \`style\`: Code style changes (formatting, etc.)',
                '- \`refactor\`: Code refactoring',
                '- \`perf\`: Performance improvement',
                '- \`test\`: Adding or updating tests',
                '- \`chore\`: Build process or tooling changes',
                '',
                '**Examples:**',
                '- \`feat(timeline): add week view support\`',
                '- \`fix(auth): handle expired token refresh\`',
                '- \`docs(readme): update installation instructions\`',
                '',
                'Please update your PR title to match this format. ðŸ™',
              ].join('\n');

              // Check if we already commented
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number
              });
              
              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('PR Title Check Failed')
              );
              
              if (botComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: comment
                });
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: comment
                });
              }
              
              core.setFailed('PR title does not follow Conventional Commits format');
            } else {
              console.log('âœ… PR title follows Conventional Commits format');
              
              // Remove comment if it exists and title is now valid
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number
              });
              
              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('PR Title Check Failed')
              );
              
              if (botComment) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id
                });
              }
            }

      - name: Check PR description
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';

            // Check if PR has a description
            if (body.trim().length < 50) {
              const comment = [
                'âš ï¸ **PR Description Warning**',
                '',
                'Your PR description seems quite short. Please provide more context:',
                '',
                '- What changes were made?',
                '- Why were these changes necessary?',
                '- How can reviewers test these changes?',
                '- Are there any breaking changes?',
                '- Screenshots/videos (if UI changes)',
                '',
                'A detailed description helps reviewers understand your changes better! ðŸ“',
              ].join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: comment
              });
            }

      - name: Check for linked issues
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';

            // Check if PR links to an issue
            const issuePattern = /(close[sd]?|fix(e[sd])?|resolve[sd]?)\s+#\d+/i;

            if (!issuePattern.test(body)) {
              const comment = [
                'â„¹ï¸ **Issue Link Suggestion**',
                '',
                'Consider linking this PR to a related issue using keywords:',
                '- \`Closes #123\`',
                '- \`Fixes #456\`',
                '- \`Resolves #789\`',
                '',
                'This helps track the relationship between issues and PRs! ðŸ”—',
              ].join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: comment
              });
            }
